version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - echo "Current working directory is $(pwd)"
        - ls -la
        - mkdir -p public
        - npm run build
        - mkdir -p .next/standalone/.next
        - cp -R .next/static .next/standalone/.next/
        - mkdir -p .next/standalone/public
        - if [ -d "public" ]; then cp -R public/* .next/standalone/public/ || echo "No files to copy from public"; fi
        - if [ -f "server.js" ]; then 
            cp server.js .next/standalone/; 
          else 
            echo "Server.js not found, creating a basic server file";
            echo 'const next = require("next");
            const { createServer } = require("http");
            const app = next({ dev: false, dir: __dirname });
            const handle = app.getRequestHandler();
            app.prepare().then(() => {
              createServer((req, res) => {
                handle(req, res);
              }).listen(process.env.PORT || 3000, err => {
                if (err) throw err;
                console.log("> Ready on port " + (process.env.PORT || 3000));
              });
            });' > .next/standalone/server.js;
          fi
        - ls -la .next/standalone
  artifacts:
    baseDirectory: .next/standalone
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/* 